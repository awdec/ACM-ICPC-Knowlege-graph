# 模块介绍

<cite>
**Referenced Files in This Document**   
- [app.py](file://src/app.py)
- [nl_to_cypher.py](file://src/nl_to_cypher.py)
- [neo4j_helper.py](file://src/neo4j_helper.py)
- [answer_renderer.py](file://src/answer_renderer.py)
</cite>

## 目录
1. [app.py：主应用入口与界面集成](#apppy主应用入口与界面集成)
2. [nl_to_cypher.py：自然语言解析与Cypher生成](#nl_to_cyperpy自然语言解析与cypher生成)
3. [neo4j_helper.py：Neo4j数据库交互封装](#neo4j_helperpyneo4j数据库交互封装)
4. [answer_renderer.py：查询结果渲染器](#answer_rendererpy查询结果渲染器)

## app.py：主应用入口与界面集成

`app.py` 是整个系统的主入口文件，负责集成 Streamlit 用户界面与后端逻辑，协调用户输入、调用其他模块并展示最终结果。该模块通过环境变量配置 Neo4j 数据库连接参数（URI、用户名、密码），并创建 `Neo4jHelper` 实例以实现与图数据库的通信。

当用户在输入框中提交中文问题并点击“查询”按钮后，系统首先调用 `nl_to_cypher.py` 模块中的 `parse_intent` 函数对问题进行意图识别和槽位提取。若识别出有效意图，则进一步调用 `get_cypher_and_params` 获取对应的 Cypher 查询语句及其参数。随后，系统使用 `Neo4jHelper` 实例执行该查询，并将原始结果传递给 `answer_renderer.py` 模块进行格式化渲染。最终，系统在界面上分步展示解析结果、Cypher 语句、原始数据及自然语言形式的答案。对于无法识别的意图或执行错误，系统会提供相应的警告或错误信息。

此模块作为系统的协调中枢，清晰地串联了自然语言理解、数据库查询与结果呈现三大核心流程。

**Section sources**
- [app.py](file://src/app.py#L1-L44)

## nl_to_cypher.py：自然语言解析与Cypher生成

`nl_to_cypher.py` 模块的核心功能是将用户输入的中文自然语言问题转换为结构化的查询意图与参数，并最终生成可执行的 Cypher 查询语句。其实现基于预定义的正则表达式规则集（`INTENT_PATTERNS`），每条规则对应一种查询意图（如获取题目难度、列出某标签下的题目等），并包含一个正则模式用于匹配用户问题中的关键词和实体（即“槽位”）。

`parse_intent` 函数遍历这些规则，尝试匹配输入问题。一旦匹配成功，便提取出相应的槽位值（如题目名、标签名、作者名等），并返回包含意图类型和槽位信息的字典。这种设计具有良好的可扩展性：新增查询类型时，只需在 `INTENT_PATTERNS` 列表中添加新的元组（意图名、正则模式、槽位名），并在 `CYPHER_TEMPLATES` 字典中提供对应的 Cypher 模板即可，无需修改核心解析逻辑。

`get_cypher_and_params` 函数则根据 `parse_intent` 返回的意图，从 `CYPHER_TEMPLATES` 中查找并返回相应的 Cypher 查询模板和参数字典。Cypher 模板中使用 `$parameter` 语法引用参数，确保了查询的安全性，避免了 SQL 注入风险。

**Section sources**
- [nl_to_cypher.py](file://src/nl_to_cypher.py#L1-L47)

## neo4j_helper.py：Neo4j数据库交互封装

`neo4j_helper.py` 模块封装了与 Neo4j 图数据库交互的所有操作，提供了简洁、安全且易于使用的接口。该模块定义了 `Neo4jHelper` 类，其构造函数接收数据库的连接 URI、用户名和密码，并初始化一个数据库驱动实例。

核心方法 `run_query` 接受一个 Cypher 查询字符串和一个参数字典。它通过驱动创建一个会话（session），在该会话中安全地执行带参数的查询。参数化查询（parameterized query）是此模块的关键安全特性，它确保用户输入的数据不会被直接拼接到 Cypher 语句中，从而有效防止了潜在的注入攻击。查询结果以字典列表的形式返回，便于上层模块处理。

此外，该模块还提供了 `close` 方法用于显式关闭数据库连接，尽管在当前的 Streamlit 应用上下文中可能不是必需的。整体设计遵循了资源管理的最佳实践，确保了数据库操作的健壮性和安全性。

**Section sources**
- [neo4j_helper.py](file://src/neo4j_helper.py#L1-L16)

## answer_renderer.py：查询结果渲染器

`answer_renderer.py` 模块负责将从数据库获取的原始数据（字典列表）转换为用户友好的自然语言文本。其核心函数 `render_answer` 根据不同的查询意图（intent）采用不同的渲染策略，生成结构化的输出。

对于单一结果的查询（如 `get_problem_info`），函数会提取第一条记录，并将其各个字段（如题目名、难度、标签、题解ID）格式化为一段清晰的段落。对于多条结果的查询（如 `list_problems_by_tag` 或 `get_contest_winner`），函数会将每条记录渲染为一个列表项，并用换行符连接，形成一个有序或无序的列表。对于包含摘要信息的查询（如 `get_solutions_by_author`），函数会使用更复杂的格式，将问题名、题解ID和内容摘要分开展示，并用空行分隔不同的条目，以提高可读性。

该模块的实现体现了良好的关注点分离原则，将数据展示逻辑从核心业务逻辑中剥离。其设计具有可扩展性，当新增查询类型时，只需在 `render_answer` 函数中添加新的条件分支即可。对于无法识别的意图，模块提供了一个后备机制，直接返回原始数据的字符串表示，确保系统不会因未知意图而崩溃。

**Section sources**
- [answer_renderer.py](file://src/answer_renderer.py#L1-L31)